<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//En"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="com.ericsson.raso.sef.core.db.mapper.TicketMapper">

	<resultMap id="TicketResult" type="Ticket">
		<id property="ticketId" column="ticket_id" />
		<id property="purchaseId" column="purchase_id" />
		<result property="ticketType" column="ticket_type" />
		<result property="limit" column="ticket_limit" />
		<result property="count" column="count_ticket" />
		<result property="descriptionEn" column="descriptionn_en" />
		<result property="state" column="state" />
		<result property="resourceType" column="resource_type" />
		<result property="expiry" column="expiry" />
		<result property="productId" column="product_id" />
	</resultMap>

	<resultMap id="TicketMetaResult" type="TicketMeta">
		<id property="ticketId" column="ticket_id" />
		<id property="key" column="meta_key" />
		<result property="value" column="meta_value" />
	</resultMap>
	
	<insert id="createTicket" parameterType="Ticket">
		insert into ticket (purchase_id,ticket_id,ticket_type,ticket_limit,count_ticket,state,resource_type,expiry,product_id)
		values
		(#{purchaseId jdbcType=VARCHAR}, 
		#{ticketId jdbcType=VARCHAR}, 
		#{ticketType jdbcType=VARCHAR}, 
		#{limit jdbcType=VARCHAR}, 
		#{count jdbcType=NUMERIC}, 		
		#{state jdbcType=VARCHAR}, 
		#{resourceType jdbcType=VARCHAR}, 
		#{expiry jdbcType=TIMESTAMP}, 
		#{productId jdbcType=VARCHAR})
	</insert>

	<delete id="deleteTicket" parameterType="String">
		delete from ticket where ticket_id = #{ticketId};
	</delete>
	
	<delete id="deleteTicketMeta" parameterType="String">
		delete from ticket_meta where ticket_id = #{ticketId}
	</delete>
	
	<select id="getTicket" resultMap="TicketResult" parameterType="String">
		select t.purchase_id, t.ticket_id, t.ticket_type, t.ticket_limit, t.count_ticket, t.description_en, t.state, t.resource_type, t.expiry, t.product_id
		from ticket t
		where ticket_id = #{ticketId}
	</select>
	
	<update id="updateTicket" parameterType="Ticket">
		update ticket 
		<set>
		<if test="ticketId != null">ticket_id=#{tickeId jdbcType=VARCHAR},</if>
		<if test="purchaseId != null">purchase_id=#{purchaseId jdbcType=VARCHAR},</if>
		<if test="ticketType != null">ticket_type=#{tickeType jdbcType=VARCHAR},</if>
		<if test="limit != null"> ticket_limit=#{limit jdbcType=VARCHAR},</if>
		<if test="count != null"> count_ticket=#{count jdbcType=VARCHAR},</if>
		<if test="descriptionEn != null"> description_en=#{descriptionEn jdbcType=VARCHAR},</if>
		<if test="state != null"> state=#{state jdbcType=VARCHAR},</if>
		<if test="resourceType != null"> resource_type=#{resourceType jdbcType=VARCHAR},</if>
		<if test="expiry != null"> expiry=#{expiry jdbcType=TIMESTAMP},</if>
		<if test="productId != null"> product_id=#{productId jdbcType=VARCHAR},</if>
		</set>
		where ticket_id = #{ticketId}
	</update>

	<select id="getTicketMetas" resultMap="TicketMetaResult" parameterType="map">
		select tm.ticket_id, tm.meta_key, tm.meta_value
		from
		ticket_meta tm
		where ticket_id = #{ticketId}
		and meta_key in
		<foreach item="item" index="index" collection="keys" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>
	

	<insert id="insertTicketMeta" parameterType="TicketMeta">
		insert into ticket_meta (ticket_id, meta_key, meta_value)
		values
		(#{ticketId jdbcType=VARCHAR}, #{key jdbcType=VARCHAR}, #{value jdbcType=VARCHAR})
	</insert>

	<update id="updateTicketMeta" parameterType="TicketMeta">
		update ticket_meta
		<set>
		<if test="value != null">meta_value=#{value jdbcType=VARCHAR},</if>
		</set>
		where ticket_id = #{ticketId}
		and meta_key = #{key}
		
	</update>
	
	
	
	<select id="getTicketByPurchaseId" resultMap="TicketResult" parameterType="String">
		select t.purchase_id, t.ticket_id, t.ticket_type, t.ticket_limit, t.count_ticket, t.description_en, t.state, t.resource_type, t.expiry, t.product_id
		from ticket t
		where purchase_id = #{purchaseId}
	</select>
	
	
	
</mapper>
        